name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Build test portfolio
        run: npm run test:build

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Upload test results (on failure)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results
          path: test-results/
          retention-days: 14

  check-publish:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    outputs:
      should_publish: ${{ steps.check.outputs.should_publish }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for publishable changes
        id: check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_publish=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if any publishable files changed
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")

          DOMINATED_PATHS="engine/ scripts/ bin/ templates/ index.js package.json README.md LICENSE"
          SHOULD_PUBLISH=false

          for file in $CHANGED; do
            for path in $DOMINATED_PATHS; do
              if [[ "$file" == $path* ]] || [[ "$file" == "$path" ]]; then
                # Exclude non-README markdown files
                if [[ "$file" == *.md ]] && [[ "$file" != "README.md" ]]; then
                  continue
                fi
                SHOULD_PUBLISH=true
                break 2
              fi
            done
          done

          echo "should_publish=$SHOULD_PUBLISH" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED"
          echo "Should publish: $SHOULD_PUBLISH"

  publish:
    needs: [test, check-publish]
    if: needs.check-publish.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Verify package structure
        run: |
          echo "Checking required directories..."
          ls -la engine/
          ls -la scripts/
          ls -la bin/
          ls -la templates/

      - name: Create package tarball (dry run)
        run: npm pack --dry-run

      - name: Bump version
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION_TYPE="${{ github.event.inputs.version }}"
          else
            VERSION_TYPE="patch"
          fi

          HUSKY=0 npm version $VERSION_TYPE -m "chore: release v%s"
          git push --follow-tags

      - name: Publish to NPM
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Summary
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "### Published @mtldev514/retro-portfolio-maker@$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Install: \`npm install @mtldev514/retro-portfolio-maker@$VERSION\`" >> $GITHUB_STEP_SUMMARY
