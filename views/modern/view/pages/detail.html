<div id="detail-container">
    <p class="empty-message" data-i18n="detail_loading">Loading...</p>
</div>

<script>
    (async function loadDetail() {
        const container = document.getElementById('detail-container');
        if (!container) return;

        const tf = (field) => {
            if (!field) return '';
            if (typeof field === 'object' && !Array.isArray(field)) {
                const lang = (window.i18n && i18n.currentLang) || 'en';
                return field[lang] || field.en || '';
            }
            return field;
        };
        const t = (key, fallback) => (window.i18n && i18n.translations[key]) || fallback;

        const params = new URLSearchParams(window.location.search);
        const itemId = params.get('id');
        const from = params.get('from') || 'gallery';

        // Build category map from config
        let categoryMap = {};
        if (window.AppConfig) {
            if (!AppConfig.loaded) await AppConfig.load();
        }
        const cats = window.AppConfig?.getAllCategories() || [];
        cats.forEach(cat => {
            categoryMap[cat.id] = { mediaType: cat.mediaType, back: 'index.html' };
        });

        const category = categoryMap[from];
        if (!itemId || !category) {
            container.innerHTML = `<p class="empty-message">${t('detail_not_found', 'Item not found.')}</p>
                <p style="text-align:center"><a href="index.html" class="btn" data-i18n="gallery_back">Back to Home</a></p>`;
            return;
        }

        try {
            // Try finding in renderer.allItems first (avoids re-fetch)
            let item = null;
            const dataDir = (window.AppConfig && AppConfig.getSetting('paths.dataDir')) || 'data';

            if (window.renderer && renderer.allItems.length > 0) {
                item = renderer.allItems.find(i => {
                    const id = i.id || (typeof i.title === 'string' ? i.title : (i.title && i.title.en) || '');
                    return id === itemId;
                });
            }

            // Fallback: fetch from media-type data file
            if (!item && category.mediaType) {
                const mtFilePath = window.AppConfig
                    ? AppConfig.getMediaTypeDataFile(category.mediaType)
                    : `${dataDir}/${category.mediaType}.json`;
                const res = await fetch(mtFilePath);
                const items = await res.json();
                const found = items.find(i => i.id === itemId ||
                    (typeof i.title === 'object' && i.title.en === itemId));
                if (found) {
                    item = { ...found, _category: from, _from: from };
                }
            }

            if (!item) {
                container.innerHTML = `<p class="empty-message">${t('detail_not_found', 'Item not found.')}</p>
                    <p style="text-align:center"><a href="${category.back}" class="btn" data-i18n="gallery_back">Back</a></p>`;
                return;
            }

            const title = tf(item.title);
            const schema = window.AppConfig?.getDisplaySchema(from);
            const detail = schema?.detail || {};
            const heroType = detail.hero || 'none';

            const _svgIcons = {
                'github': '<svg class="icon" viewBox="0 0 24 24"><path d="M12 .3a12 12 0 00-3.8 23.4c.6.1.8-.3.8-.6v-2c-3.3.7-4-1.6-4-1.6-.6-1.4-1.4-1.8-1.4-1.8-1.1-.8.1-.7.1-.7 1.2.1 1.9 1.3 1.9 1.3 1.1 1.8 2.8 1.3 3.5 1 .1-.8.4-1.3.8-1.6-2.7-.3-5.5-1.3-5.5-5.9 0-1.3.5-2.4 1.2-3.2-.1-.3-.5-1.5.1-3.2 0 0 1-.3 3.4 1.2a11.5 11.5 0 016 0c2.3-1.5 3.3-1.2 3.3-1.2.7 1.7.3 2.9.1 3.2.8.8 1.2 1.9 1.2 3.2 0 4.6-2.8 5.6-5.5 5.9.4.4.8 1.1.8 2.2v3.3c0 .3.2.7.8.6A12 12 0 0012 .3z"/></svg>',
                'external-link': '<svg class="icon" viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>'
            };
            const evalCond = (cond) => !cond || item[cond.field] === cond.equals;

            let html = `<div class="detail-page">`;

            // Hero
            if (heroType === 'image-gallery' && item.url) {
                html += `<div class="detail-hero">
                    <img src="${item.url}" alt="${title}">
                    ${(item.gallery && item.gallery.length) ? `<div class="detail-gallery-thumbs">
                        ${item.gallery.map((img, i) => `<img src="${img}" class="gallery-thumb" alt="Gallery ${i+1}">`).join('')}
                    </div>` : ''}
                </div>`;
            } else if (heroType === 'play-inline' && item.url) {
                html += `<div class="detail-hero">
                    <audio controls src="${item.url}" style="width:100%"></audio>
                </div>`;
            }

            html += `<div class="detail-info">`;

            // Title with optional badge
            let badge = '';
            if (detail.titleBadge) {
                const val = item[detail.titleBadge.field];
                const spec = detail.titleBadge.map?.[val];
                if (spec) {
                    badge = `<span class="detail-badge ${spec.class || ''}">${spec.emoji} ${t(spec.labelKey, spec.labelKey)}</span>`;
                }
            }
            html += `<h2 class="detail-title">${title} ${badge}</h2>`;

            // Meta row
            if (detail.meta && detail.meta.length) {
                html += `<div class="detail-meta">`;
                for (const m of detail.meta) {
                    const val = tf(item[m.field]);
                    if (!val) continue;
                    html += `<span>${m.icon} ${t(m.labelKey, m.labelKey)} ${val}</span>`;
                }
                html += `</div>`;
            }

            // Sections
            if (detail.sections) {
                for (const sec of detail.sections) {
                    const val = tf(item[sec.field]);
                    if (!val) continue;
                    const label = t(sec.labelKey, sec.labelKey);
                    if (sec.renderer === 'preformatted') {
                        html += `<div class="detail-${sec.field}">
                            <h3>${label}</h3>
                            <pre class="lyrics-text">${val}</pre>
                        </div>`;
                    } else {
                        html += `<div class="detail-${sec.field}">
                            <h3>${label}</h3>
                            <p>${val}</p>
                        </div>`;
                    }
                }
            }

            // Actions
            if (detail.actions) {
                for (const action of detail.actions) {
                    if (!evalCond(action.condition)) continue;
                    if (!action.links) continue;
                    const links = action.links
                        .filter(l => item[l.field])
                        .map(l => `<a href="${item[l.field]}" target="_blank" class="btn">${_svgIcons[l.icon] || ''} ${t(l.labelKey, l.labelKey)}</a>`);
                    if (links.length) {
                        html += `<div class="detail-actions">${links.join('\n')}</div>`;
                    }
                }
            }

            html += `</div></div>`;
            container.innerHTML = html;

            // Lightbox for images
            const heroImg = container.querySelector('.detail-hero img:not(.gallery-thumb)');
            if (heroImg) {
                const images = [item.url, ...(item.gallery || [])];
                heroImg.style.cursor = 'pointer';
                heroImg.addEventListener('click', () => openLightbox(images, 0));
                container.querySelectorAll('.gallery-thumb').forEach((thumb, i) => {
                    thumb.addEventListener('click', () => openLightbox(images, i + 1));
                });
            }

            function openLightbox(imgs, startIdx) {
                let idx = startIdx;
                const overlay = document.createElement('div');
                overlay.className = 'lightbox-overlay';
                const render = () => {
                    overlay.innerHTML = `
                        <img src="${imgs[idx]}" class="lightbox-img">
                        ${imgs.length > 1 ? `
                            <button class="lightbox-prev">&#9664;</button>
                            <button class="lightbox-next">&#9654;</button>
                            <span class="lightbox-counter">${idx + 1} / ${imgs.length}</span>
                        ` : ''}
                    `;
                };
                render();
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) { overlay.remove(); document.removeEventListener('keydown', kbHandler); }
                    if (e.target.closest('.lightbox-prev')) { idx = (idx - 1 + imgs.length) % imgs.length; render(); }
                    if (e.target.closest('.lightbox-next')) { idx = (idx + 1) % imgs.length; render(); }
                });
                document.body.appendChild(overlay);
                const kbHandler = (e) => {
                    if (e.key === 'Escape') { overlay.remove(); document.removeEventListener('keydown', kbHandler); }
                    if (e.key === 'ArrowLeft') { idx = (idx - 1 + imgs.length) % imgs.length; render(); }
                    if (e.key === 'ArrowRight') { idx = (idx + 1) % imgs.length; render(); }
                };
                document.addEventListener('keydown', kbHandler);
            }

            if (window.i18n) window.i18n.updateDOM();

        } catch (e) {
            console.error('Detail load error:', e);
            container.innerHTML = `<p class="empty-message">${t('detail_error', 'Could not load item details.')}</p>
                <p style="text-align:center"><a href="index.html" class="btn" data-i18n="gallery_back">Back to Home</a></p>`;
        }
    })();
</script>
