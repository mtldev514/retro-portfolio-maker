/**
 * Init Script
 * Creates a new portfolio with template data structure
 */

const fs = require('fs-extra');
const path = require('path');
const chalk = require('chalk');

async function init(targetDir, options = {}) {
  console.log(chalk.blue('ğŸ¨ Initializing Retro Portfolio...\n'));

  const targetPath = path.resolve(process.cwd(), targetDir);
  const templatePath = path.join(__dirname, '../templates/user-portfolio');

  // Check if directory exists
  if (fs.existsSync(targetPath) && fs.readdirSync(targetPath).length > 0) {
    if (!options.force) {
      throw new Error(
        `Directory ${targetDir} is not empty. Use --force to overwrite.`
      );
    }
  }

  // Create directory structure
  console.log(chalk.cyan('ğŸ“ Creating directory structure...'));

  const dirs = ['config', 'data', 'lang', 'assets'];
  for (const dir of dirs) {
    const dirPath = path.join(targetPath, dir);
    await fs.ensureDir(dirPath);
    console.log(chalk.green('  âœ“'), dir + '/');
  }

  // Copy template files
  console.log(chalk.cyan('\nğŸ“„ Creating template files...'));

  // package.json
  const packageJson = {
    name: path.basename(targetPath),
    version: '1.0.0',
    private: true,
    scripts: {
      build: 'npx retro-portfolio build',
      dev: 'npx retro-portfolio dev',
      admin: 'npx retro-portfolio admin',
      start: 'npm run dev & npm run admin',
      deploy: 'npx retro-portfolio deploy',
      postinstall: 'pip3 install flask flask-cors 2>/dev/null || pip install flask flask-cors 2>/dev/null || echo "âš ï¸  Please install Flask manually: pip install flask flask-cors"'
    },
    dependencies: {
      '@mtldev514/retro-portfolio-engine': '^1.0.0'
    }
  };

  await fs.writeJson(path.join(targetPath, 'package.json'), packageJson, {
    spaces: 2
  });
  console.log(chalk.green('  âœ“'), 'package.json');

  // .gitignore
  const gitignore = `# Dependencies
node_modules/

# Build output
dist/

# Environment
.env
.env.local

# Editor
.vscode/
.idea/
*.swp

# OS
.DS_Store
Thumbs.db

# Temp
temp_uploads/
.cache/
`;

  await fs.writeFile(path.join(targetPath, '.gitignore'), gitignore);
  console.log(chalk.green('  âœ“'), '.gitignore');

  // .env.example
  const envExample = `# Cloudinary Configuration (for media uploads)
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret

# Optional: Custom engine version
# ENGINE_VERSION=1.0.0
`;

  await fs.writeFile(path.join(targetPath, '.env.example'), envExample);
  console.log(chalk.green('  âœ“'), '.env.example');

  // Create config files
  const configFiles = {
    'config/app.json': {
      site: {
        name: 'My Retro Portfolio',
        description: 'A nostalgic web presence',
        author: 'Your Name'
      },
      theme: {
        default: 'jr16'
      }
    },
    'config/languages.json': {
      defaultLanguage: 'en',
      supportedLanguages: [
        { code: 'en', name: 'English', flag: 'ğŸ‡¬ğŸ‡§' },
        { code: 'fr', name: 'FranÃ§ais', flag: 'ğŸ‡«ğŸ‡·' }
      ]
    },
    'config/categories.json': {
      contentTypes: [
        {
          id: 'painting',
          name: { en: 'Painting', fr: 'Peinture' },
          icon: 'ğŸ¨',
          mediaType: 'image',
          dataFile: 'data/painting.json'
        },
        {
          id: 'projects',
          name: { en: 'Projects', fr: 'Projets' },
          icon: 'ğŸ’»',
          mediaType: 'code',
          dataFile: 'data/projects.json'
        }
      ]
    },
    'config/media-types.json': {
      mediaTypes: [
        {
          id: 'image',
          name: 'Image',
          supportsGallery: true,
          acceptedFormats: ['jpg', 'png', 'gif', 'webp']
        },
        {
          id: 'code',
          name: 'Code Project',
          supportsGallery: false
        }
      ]
    }
  };

  for (const [filePath, content] of Object.entries(configFiles)) {
    const fullPath = path.join(targetPath, filePath);
    await fs.writeJson(fullPath, content, { spaces: 2 });
    console.log(chalk.green('  âœ“'), filePath);
  }

  // Create empty data files
  const dataFiles = ['painting', 'projects'];
  for (const file of dataFiles) {
    const filePath = path.join(targetPath, 'data', `${file}.json`);
    await fs.writeJson(filePath, { items: [] }, { spaces: 2 });
    console.log(chalk.green('  âœ“'), `data/${file}.json`);
  }

  // Create language files
  const langFiles = {
    'lang/en.json': {
      header_title: 'My Portfolio',
      nav_painting: 'Painting',
      nav_projects: 'Projects',
      footer_copy: 'Â© 2026 My Portfolio'
    },
    'lang/fr.json': {
      header_title: 'Mon Portfolio',
      nav_painting: 'Peinture',
      nav_projects: 'Projets',
      footer_copy: 'Â© 2026 Mon Portfolio'
    }
  };

  for (const [filePath, content] of Object.entries(langFiles)) {
    const fullPath = path.join(targetPath, filePath);
    await fs.writeJson(fullPath, content, { spaces: 2 });
    console.log(chalk.green('  âœ“'), filePath);
  }

  // Create README
  const readme = `# ${path.basename(targetPath)}

A retro-styled portfolio powered by [@mtldev514/retro-portfolio-engine](https://www.npmjs.com/package/@mtldev514/retro-portfolio-engine).

## ğŸš€ Quick Start

\`\`\`bash
# Install dependencies (includes Python Flask auto-install)
npm install

# Launch site + admin in parallel (recommended)
npm start
# â†’ Site: http://localhost:8000
# â†’ Admin: http://localhost:5001/admin.html

# Or launch them separately:
npm run dev      # Site only (http://localhost:8000)
npm run admin    # Admin only (http://localhost:5001/admin.html)
\`\`\`

## ğŸ“ Project Structure

- \`config/\` - Site configuration (app, languages, categories)
- \`data/\` - Your portfolio content (JSON files)
- \`lang/\` - Translations (en.json, fr.json, etc.)
- \`assets/\` - Your images and media files

## ğŸ¨ Admin Interface

The admin interface allows you to:
- Upload and manage images
- Edit content in all languages
- Add/edit/delete portfolio items
- Manage translations

Access it at **http://localhost:5001/admin.html** after running \`npm start\` or \`npm run admin\`.

## ğŸ—ï¸ Building for Production

\`\`\`bash
# Build the static site
npm run build

# Output will be in dist/ folder
# Deploy dist/ to GitHub Pages, Netlify, Vercel, etc.
\`\`\`

## ğŸŒ Deployment

### GitHub Pages (Automated)

This project includes a GitHub Action for automatic deployment.

1. Push your code to GitHub
2. Enable GitHub Pages in repository settings
3. On every push to \`main\`, the site will automatically build and deploy

### Manual Deployment

\`\`\`bash
npm run build
# Then deploy the dist/ folder to your hosting provider
\`\`\`

## ğŸ”§ Configuration

### Cloudinary (for image uploads)

1. Create a free account at [Cloudinary](https://cloudinary.com)
2. Copy \`.env.example\` to \`.env\`
3. Add your Cloudinary credentials to \`.env\`

\`\`\`bash
cp .env.example .env
nano .env  # Edit with your credentials
\`\`\`

### Customization

- **Site name**: Edit \`config/app.json\`
- **Languages**: Edit \`config/languages.json\`
- **Categories**: Edit \`config/categories.json\`
- **Content**: Use the admin interface or edit JSON files in \`data/\`

## ğŸ“š Available Commands

- \`npm start\` - Launch site + admin together
- \`npm run dev\` - Development server (site only)
- \`npm run admin\` - Admin interface
- \`npm run build\` - Build for production
- \`npm run deploy\` - Deploy to GitHub Pages

## ğŸ†˜ Troubleshooting

### Admin won't start

Make sure Flask is installed:

\`\`\`bash
pip install flask flask-cors
\`\`\`

### Images won't upload

Check your \`.env\` file has valid Cloudinary credentials.

### Site won't build

Make sure all required files exist in \`config/\`, \`data/\`, and \`lang/\` directories.

## ğŸ“– Documentation

- [Engine Documentation](https://github.com/mtldev514/retro-portfolio-engine)
- [NPM Package](https://www.npmjs.com/package/@mtldev514/retro-portfolio-engine)

## ğŸ“„ License

MIT

---

**Made with ğŸ’œ using @mtldev514/retro-portfolio-engine**
`;

  await fs.writeFile(path.join(targetPath, 'README.md'), readme);
  console.log(chalk.green('  âœ“'), 'README.md');

  // Success message
  console.log(chalk.green('\nâœ¨ Portfolio initialized successfully!\n'));
  console.log(chalk.cyan('Next steps:\n'));
  console.log(`  cd ${targetDir}`);
  console.log('  npm install');
  console.log('  npm run dev\n');
  console.log(chalk.gray('Happy creating! ğŸ¨\n'));

  return true;
}

module.exports = init;
