<div id="detail-container">
    <p class="empty-message" data-i18n="detail_loading">Loading...</p>
</div>

<script>
    (async function loadDetail() {
        const container = document.getElementById('detail-container');
        if (!container) return;

        const tf = (field) => {
            if (!field) return '';
            if (typeof field === 'object' && !Array.isArray(field)) {
                const lang = (window.i18n && i18n.currentLang) || 'en';
                return field[lang] || field.en || '';
            }
            return field;
        };
        const t = (key, fallback) => (window.i18n && i18n.translations[key]) || fallback;

        // Read query params: ?id=xxx&from=gallery
        const params = new URLSearchParams(window.location.search);
        const itemId = params.get('id');
        const from = params.get('from') || 'gallery';

        // Build category map dynamically from config
        let categoryMap = {};
        if (window.AppConfig) {
            if (!AppConfig.loaded) await AppConfig.load();
        }
        const cats = window.AppConfig?.getAllCategories() || [];
        cats.forEach(cat => {
            categoryMap[cat.id] = { mediaType: cat.mediaType, back: 'index.html' };
        });

        const category = categoryMap[from];
        if (!itemId || !category) {
            container.innerHTML = `<p class="empty-message">${t('detail_not_found', 'Item not found.')}</p>
                <p align="center"><a href="index.html" class="btn" data-i18n="gallery_back">Back to Home</a></p>`;
            return;
        }

        try {
            // Try finding in renderer.allItems first (avoids re-fetch)
            let item = null;
            const dataDir = (window.AppConfig && AppConfig.getSetting('paths.dataDir')) || 'data';

            if (window.renderer && renderer.allItems.length > 0) {
                item = renderer.allItems.find(i => {
                    const id = i.id || (typeof i.title === 'string' ? i.title : (i.title && i.title.en) || '');
                    return id === itemId;
                });
            }

            // Fallback: fetch from media-type data file (normalized format)
            if (!item && category.mediaType) {
                const mtFilePath = window.AppConfig
                    ? AppConfig.getMediaTypeDataFile(category.mediaType)
                    : `${dataDir}/${category.mediaType}.json`;
                const res = await fetch(mtFilePath);
                const items = await res.json();
                const found = items.find(i => i.id === itemId ||
                    (typeof i.title === 'object' && i.title.en === itemId));
                if (found) {
                    item = { ...found, _category: from, _from: from };
                }
            }

            if (!item) {
                container.innerHTML = `<p class="empty-message">${t('detail_not_found', 'Item not found.')}</p>
                    <p align="center"><a href="${category.back}" class="btn" data-i18n="gallery_back">Back</a></p>`;
                return;
            }

            const title = tf(item.title);
            const description = tf(item.description);
            const medium = tf(item.medium);
            const genre = tf(item.genre);
            const createdStr = item.created || '';
            const dateStr = item.date || 'N/A';
            const isProject = (from === 'projects');
            const isMusic = (from === 'music');

            let visibilityBadge = '';
            if (isProject) {
                visibilityBadge = item.visibility === 'private'
                    ? `<span class="detail-badge detail-badge-private">üîí ${t('detail_private', 'Private')}</span>`
                    : `<span class="detail-badge detail-badge-public">üåç ${t('detail_public', 'Public')}</span>`;
            }

            const lyrics = tf(item.lyrics);

            let html = `<div class="detail-page">`;

            // Image hero (for art/photo/sculpting)
            if (item.url && !isProject && !isMusic) {
                html += `<div class="detail-hero">
                    <img src="${item.url}" alt="${title}">
                    ${(item.gallery && item.gallery.length) ? `<div class="detail-gallery-thumbs">
                        ${item.gallery.map((img, i) => `<img src="${img}" class="gallery-thumb" alt="Gallery ${i+1}">`).join('')}
                    </div>` : ''}
                </div>`;
            }

            html += `<div class="detail-info">`;

            // For music: play button inline with title
            if (isMusic && item.url) {
                html += `<h2 class="detail-title">${title}
                    <button class="track-radio-btn detail-play-inline" id="detail-play-radio" data-track-url="${item.url.replace(/"/g, '&quot;')}">
                        &#9654; ${t('music_play_in_radio', 'Play in Radio')}
                    </button>
                </h2>`;
            } else {
                html += `<h2 class="detail-title">${title} ${visibilityBadge}</h2>`;
            }

            // Meta row
            html += `<div class="detail-meta">`;
            if (medium) html += `<span>üé® ${t('detail_medium', 'Medium:')} ${medium}</span>`;
            if (genre) html += `<span>üéµ ${t('detail_genre', 'Genre:')} ${genre}</span>`;
            if (createdStr) html += `<span>üìÖ ${t('gallery_created_on', 'Created:')} ${createdStr}</span>`;
            html += `<span>üìÅ ${t('gallery_added_on', 'Added:')} ${dateStr}</span>`;
            html += `</div>`;

            // Description
            if (description) {
                html += `<div class="detail-description">
                    <h3>${t('detail_description', 'Description')}</h3>
                    <p>${description}</p>
                </div>`;
            }

            // Lyrics for music
            if (isMusic && lyrics) {
                html += `<div class="detail-lyrics">
                    <h3>${t('detail_lyrics', 'Lyrics')}</h3>
                    <pre class="lyrics-text">${lyrics}</pre>
                </div>`;
            }

            // Links for public projects only
            if (isProject && item.visibility === 'public') {
                if (item.website) {
                    html += `<div class="detail-actions">
                        <a href="${item.website}" target="_blank" class="btn"><svg class="icon" viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg> ${t('card_website', 'Website')}</a>
                        <a href="${item.url}" target="_blank" class="btn"><svg class="icon" viewBox="0 0 24 24"><path d="M12 .3a12 12 0 00-3.8 23.4c.6.1.8-.3.8-.6v-2c-3.3.7-4-1.6-4-1.6-.6-1.4-1.4-1.8-1.4-1.8-1.1-.8.1-.7.1-.7 1.2.1 1.9 1.3 1.9 1.3 1.1 1.8 2.8 1.3 3.5 1 .1-.8.4-1.3.8-1.6-2.7-.3-5.5-1.3-5.5-5.9 0-1.3.5-2.4 1.2-3.2-.1-.3-.5-1.5.1-3.2 0 0 1-.3 3.4 1.2a11.5 11.5 0 016 0c2.3-1.5 3.3-1.2 3.3-1.2.7 1.7.3 2.9.1 3.2.8.8 1.2 1.9 1.2 3.2 0 4.6-2.8 5.6-5.5 5.9.4.4.8 1.1.8 2.2v3.3c0 .3.2.7.8.6A12 12 0 0012 .3z"/></svg> ${t('projects_view_code', 'View Source')}</a>
                    </div>`;
                } else if (item.url) {
                    html += `<div class="detail-actions">
                        <a href="${item.url}" target="_blank" class="btn"><svg class="icon" viewBox="0 0 24 24"><path d="M12 .3a12 12 0 00-3.8 23.4c.6.1.8-.3.8-.6v-2c-3.3.7-4-1.6-4-1.6-.6-1.4-1.4-1.8-1.4-1.8-1.1-.8.1-.7.1-.7 1.2.1 1.9 1.3 1.9 1.3 1.1 1.8 2.8 1.3 3.5 1 .1-.8.4-1.3.8-1.6-2.7-.3-5.5-1.3-5.5-5.9 0-1.3.5-2.4 1.2-3.2-.1-.3-.5-1.5.1-3.2 0 0 1-.3 3.4 1.2a11.5 11.5 0 016 0c2.3-1.5 3.3-1.2 3.3-1.2.7 1.7.3 2.9.1 3.2.8.8 1.2 1.9 1.2 3.2 0 4.6-2.8 5.6-5.5 5.9.4.4.8 1.1.8 2.2v3.3c0 .3.2.7.8.6A12 12 0 0012 .3z"/></svg> ${t('projects_view_code', 'View Source')}</a>
                    </div>`;
                }
            }

            html += `</div>`; // .detail-info
            html += `</div>`; // .detail-page

            container.innerHTML = html;

            // Wire up "Play in Radio" button for music
            const playRadioBtn = document.getElementById('detail-play-radio');
            if (playRadioBtn) {
                playRadioBtn.addEventListener('click', () => {
                    const url = playRadioBtn.dataset.trackUrl;
                    if (window.media && media.playlist) {
                        const idx = media.playlist.findIndex(p => p.src === url);
                        if (idx >= 0) media.switchTrack(idx);
                    }
                });
            }

            // Lightbox for art/photo/sculpting images
            const heroImg = container.querySelector('.detail-hero img:not(.gallery-thumb)');
            if (heroImg) {
                const images = [item.url, ...(item.gallery || [])];
                heroImg.style.cursor = 'pointer';
                heroImg.addEventListener('click', () => openLightbox(images, 0));
                container.querySelectorAll('.gallery-thumb').forEach((thumb, i) => {
                    thumb.addEventListener('click', () => openLightbox(images, i + 1));
                });
            }

            function openLightbox(imgs, startIdx) {
                let idx = startIdx;
                const overlay = document.createElement('div');
                overlay.className = 'lightbox-overlay';
                const render = () => {
                    overlay.innerHTML = `
                        <img src="${imgs[idx]}" class="lightbox-img">
                        ${imgs.length > 1 ? `
                            <button class="lightbox-prev">&#9664;</button>
                            <button class="lightbox-next">&#9654;</button>
                            <span class="lightbox-counter">${idx + 1} / ${imgs.length}</span>
                        ` : ''}
                    `;
                };
                render();
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) { overlay.remove(); document.removeEventListener('keydown', kbHandler); }
                    if (e.target.closest('.lightbox-prev')) { idx = (idx - 1 + imgs.length) % imgs.length; render(); }
                    if (e.target.closest('.lightbox-next')) { idx = (idx + 1) % imgs.length; render(); }
                });
                document.body.appendChild(overlay);
                const kbHandler = (e) => {
                    if (e.key === 'Escape') { overlay.remove(); document.removeEventListener('keydown', kbHandler); }
                    if (e.key === 'ArrowLeft') { idx = (idx - 1 + imgs.length) % imgs.length; render(); }
                    if (e.key === 'ArrowRight') { idx = (idx + 1) % imgs.length; render(); }
                };
                document.addEventListener('keydown', kbHandler);
            }

            // Update i18n if available
            if (window.i18n) window.i18n.updateDOM();

        } catch (e) {
            console.error('Detail load error:', e);
            container.innerHTML = `<p class="empty-message">${t('detail_error', 'Could not load item details.')}</p>
                <p align="center"><a href="index.html" class="btn" data-i18n="gallery_back">Back to Home</a></p>`;
        }
    })();
</script>
